<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Web Form Filler with Signatures</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee; }
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:var(--bg); margin:0; padding:2rem; }
  .card { background:var(--card); border-radius:12px; padding:1.5rem; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:1.5rem; }
  h2 { font-size:1.1rem; margin-bottom:0.8rem; color:#111; }
  label { display:block; margin-bottom:1rem; }
  input, select { width:100%; padding:0.5rem; border:1px solid var(--line); border-radius:8px; font-size:1rem; }
  button { background:var(--accent); color:#fff; border:none; padding:0.6rem 1rem; border-radius:8px; cursor:pointer; font-size:0.9rem; }
  button:hover { opacity:0.9; }

  /* Signature UI */
  .sig-block { margin-bottom:1.5rem; }
  .sig-label { font-weight:500; margin-bottom:0.5rem; }
  .sig-pad { border:1px solid var(--line); border-radius:8px; width:100%; height:150px; background:#fff; touch-action:none; }
  .sig-actions { margin-top:0.5rem; display:flex; gap:0.5rem; }
  .sig-preview { margin-top:0.5rem; border:1px solid var(--line); border-radius:8px; padding:0.3rem; background:#fafafa; max-width:250px; }
  .sig-preview img { max-width:100%; display:block; }
</style>
</head>
<body>

<div class="card">
  <h2>Form Filler</h2>
  <form id="fillerForm">
    <!-- Example text inputs -->
    <label>Policy No <input type="text" name="PolicyNo" required /></label>
    <label>Insured Name <input type="text" name="InsuredName" required /></label>

    <!-- Signatures will be injected here -->
    <div id="signatures"></div>

    <button type="button" onclick="exportPDF()">Export PDF</button>
  </form>
</div>

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
/* ===== Schema (fields + signatures) ===== */
const schema = {
  fields: [
    { label: "Policy No", id: "PolicyNo" },
    { label: "Insured Name", id: "InsuredName" }
  ],
  signatures: [
    { title: "Owner Signature", id: "sig_owner", x:50, y:400, scale:0.45, page:0 },
    { title: "Payor Signature", id: "sig_payor", x:300, y:400, scale:0.45, page:0 }
  ]
};

/* ===== Signature Module ===== */
function createSignaturePad(id, label){
  const wrap=document.createElement("div");
  wrap.className="sig-block";
  wrap.innerHTML=`
    <div class="sig-label">${label}</div>
    <canvas id="${id}_pad" class="sig-pad"></canvas>
    <div class="sig-actions">
      <button type="button" onclick="clearSignature('${id}')">Clear</button>
      <button type="button" onclick="saveSignature('${id}')">Save</button>
    </div>
    <div class="sig-preview" id="${id}_preview"></div>
  `;
  document.getElementById("signatures").appendChild(wrap);
  initSignaturePad(id);
}

function initSignaturePad(id){
  const canvas=document.getElementById(id+"_pad");
  const ctx=canvas.getContext("2d");
  let drawing=false;

  function resizeCanvas(){
    canvas.width=canvas.offsetWidth;
    canvas.height=canvas.offsetHeight;
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  resizeCanvas(); window.addEventListener("resize",resizeCanvas);

  function start(e){drawing=true;ctx.beginPath();ctx.moveTo(getX(e),getY(e));e.preventDefault();}
  function draw(e){if(!drawing)return;ctx.lineTo(getX(e),getY(e));ctx.strokeStyle="#000";ctx.lineWidth=2;ctx.stroke();e.preventDefault();}
  function end(e){drawing=false;ctx.closePath();e.preventDefault();}

  function getX(e){return e.touches?e.touches[0].clientX-canvas.getBoundingClientRect().left:e.offsetX;}
  function getY(e){return e.touches?e.touches[0].clientY-canvas.getBoundingClientRect().top:e.offsetY;}

  canvas.addEventListener("mousedown",start);canvas.addEventListener("mousemove",draw);canvas.addEventListener("mouseup",end);canvas.addEventListener("mouseleave",end);
  canvas.addEventListener("touchstart",start);canvas.addEventListener("touchmove",draw);canvas.addEventListener("touchend",end);
}

function clearSignature(id){
  const canvas=document.getElementById(id+"_pad");
  const ctx=canvas.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  localStorage.removeItem(id); document.getElementById(id+"_preview").innerHTML="";
}

function saveSignature(id){
  const canvas=document.getElementById(id+"_pad");
  const dataUrl=canvas.toDataURL("image/png");
  localStorage.setItem(id,dataUrl);
  document.getElementById(id+"_preview").innerHTML=`<img src="${dataUrl}"/>`;
}

async function embedSignatures(pdfDoc){
  for(const sig of schema.signatures){
    const sigData=localStorage.getItem(sig.id);
    if(sigData){
      const png=await pdfDoc.embedPng(sigData);
      const {width,height}=png.size();
      const page=pdfDoc.getPage(sig.page||0);
      const drawW=width*sig.scale;
      const drawH=height*sig.scale;
      page.drawImage(png,{x:sig.x,y:sig.y,width:drawW,height:drawH});
    }
  }
}

/* ===== Build UI ===== */
schema.signatures.forEach(s=>createSignaturePad(s.id,s.title));

/* ===== PDF Export ===== */
async function exportPDF(){
  const pdfDoc=await PDFLib.PDFDocument.create();
  const page=pdfDoc.addPage([595,842]); // A4 blank
  const form=document.getElementById("fillerForm");

  // Add text fields
  let y=800;
  schema.fields.forEach(f=>{
    const val=form.querySelector(`[name=${f.id}]`).value;
    page.drawText(`${f.label}: ${val}`,{x:50,y:y,size:12});
    y-=20;
  });

  // Add signatures
  await embedSignatures(pdfDoc);

  const pdfBytes=await pdfDoc.save();
  const blob=new Blob([pdfBytes],{type:"application/pdf"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="filled.pdf";
  link.click();
}
</script>
</body>
</html>
